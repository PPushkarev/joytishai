{"uid":"360900af2ac46295","name":"Аудит лога: 69727f28b021b7af25e59578","fullName":"tests.test_rag_quality.TestJoytishRagas#test_ragas_full_audit","historyId":"cc2d19d4258f195a82eec57f0683b92f","time":{"start":1769111363785,"stop":1769111394726,"duration":30941},"description":"Запрос пользователя: name='Собака' date='1980-03-14' time='17:30' city='Иркутск' latitude=52.286 longitude=104.2807 timezone='Asia/Irkutsk' utc_offset=8.0 julian_day=2444312.89583 lagna=134.77 sign='Лев' planets={'Лагна': PlanetDetail(degree=\"14°46'28''\", sign='Лев', house=1, nakshatra='Пурва-Пхалгуни', pada=1, nakshatra_lord='Венера', retrograde=False, display_name='Лагна', longitude=None), 'Солнце': PlanetDetail(degree=\"0°22'44''\", sign='Рыбы', house=8, nakshatra='Пурва-Бхадрапада', pada=4, nakshatra_lord='Юпитер', retrograde=False, display_name='Солнце', longitude=None), 'Луна': PlanetDetail(degree=\"26°43'38''\", sign='Козерог', house=6, nakshatra='Дхаништха', pada=2, nakshatra_lord='Марс', retrograde=False, display_name='Луна', longitude=26.72722222222222), 'Марс': PlanetDetail(degree=\"5°39'9''\", sign='Лев', house=1, nakshatra='Магха', pada=2, nakshatra_lord='Кету', retrograde=True, display_name='Марс R', longitude=None), 'Меркурий': PlanetDetail(degree=\"15°13'5''\", sign='Водолей', house=7, nakshatra='Шатабхиша', pada=3, nakshatra_lord='Раху', retrograde=True, display_name='Меркурий R', longitude=None), 'Юпитер': PlanetDetail(degree=\"9°21'28''\", sign='Лев', house=1, nakshatra='Магха', pada=3, nakshatra_lord='Кету', retrograde=True, display_name='Юпитер R', longitude=None), 'Венера': PlanetDetail(degree=\"14°54'20''\", sign='Овен', house=9, nakshatra='Бхарани', pada=1, nakshatra_lord='Венера', retrograde=False, display_name='Венера', longitude=None), 'Сатурн': PlanetDetail(degree=\"0°2'39''\", sign='Дева', house=2, nakshatra='Уттара-Пхалгуни', pada=2, nakshatra_lord='Солнце', retrograde=True, display_name='Сатурн R', longitude=None), 'Раху': PlanetDetail(degree=\"4°25'44''\", sign='Лев', house=1, nakshatra='Магха', pada=2, nakshatra_lord='Кету', retrograde=True, display_name='Раху R', longitude=None), 'Кету': PlanetDetail(degree=\"4°25'44''\", sign='Водолей', house=7, nakshatra='Дхаништха', pada=4, nakshatra_lord='Марс', retrograde=True, display_name='Кету R', longitude=None)}","descriptionHtml":"<p>Запрос пользователя: name='Собака' date='1980-03-14' time='17:30' city='Иркутск' latitude=52.286 longitude=104.2807 timezone='Asia/Irkutsk' utc_offset=8.0 julian_day=2444312.89583 lagna=134.77 sign='Лев' planets={'Лагна': PlanetDetail(degree=&quot;14°46'28''&quot;, sign='Лев', house=1, nakshatra='Пурва-Пхалгуни', pada=1, nakshatra_lord='Венера', retrograde=False, display_name='Лагна', longitude=None), 'Солнце': PlanetDetail(degree=&quot;0°22'44''&quot;, sign='Рыбы', house=8, nakshatra='Пурва-Бхадрапада', pada=4, nakshatra_lord='Юпитер', retrograde=False, display_name='Солнце', longitude=None), 'Луна': PlanetDetail(degree=&quot;26°43'38''&quot;, sign='Козерог', house=6, nakshatra='Дхаништха', pada=2, nakshatra_lord='Марс', retrograde=False, display_name='Луна', longitude=26.72722222222222), 'Марс': PlanetDetail(degree=&quot;5°39'9''&quot;, sign='Лев', house=1, nakshatra='Магха', pada=2, nakshatra_lord='Кету', retrograde=True, display_name='Марс R', longitude=None), 'Меркурий': PlanetDetail(degree=&quot;15°13'5''&quot;, sign='Водолей', house=7, nakshatra='Шатабхиша', pada=3, nakshatra_lord='Раху', retrograde=True, display_name='Меркурий R', longitude=None), 'Юпитер': PlanetDetail(degree=&quot;9°21'28''&quot;, sign='Лев', house=1, nakshatra='Магха', pada=3, nakshatra_lord='Кету', retrograde=True, display_name='Юпитер R', longitude=None), 'Венера': PlanetDetail(degree=&quot;14°54'20''&quot;, sign='Овен', house=9, nakshatra='Бхарани', pada=1, nakshatra_lord='Венера', retrograde=False, display_name='Венера', longitude=None), 'Сатурн': PlanetDetail(degree=&quot;0°2'39''&quot;, sign='Дева', house=2, nakshatra='Уттара-Пхалгуни', pada=2, nakshatra_lord='Солнце', retrograde=True, display_name='Сатурн R', longitude=None), 'Раху': PlanetDetail(degree=&quot;4°25'44''&quot;, sign='Лев', house=1, nakshatra='Магха', pada=2, nakshatra_lord='Кету', retrograde=True, display_name='Раху R', longitude=None), 'Кету': PlanetDetail(degree=&quot;4°25'44''&quot;, sign='Водолей', house=7, nakshatra='Дхаништха', pada=4, nakshatra_lord='Марс', retrograde=True, display_name='Кету R', longitude=None)}</p>\n","status":"broken","statusMessage":"AttributeError: type object 'Dynamic' has no attribute 'status_details'","statusTrace":"self = <tests.test_rag_quality.TestJoytishRagas object at 0x7f05d1f0d6d0>\nlog_index = 1\n\n    @allure.story(\"Аудит точности ответов и поиска\")\n    @pytest.mark.asyncio\n    @pytest.mark.parametrize(\"log_index\", range(5))\n    async def test_ragas_full_audit(self, log_index):\n        \"\"\"\n        Профессиональный аудит логов:\n        1. Проверка соответствия планетам (Technical)\n        2. Проверка соответствия базе знаний PDF (Knowledge)\n        \"\"\"\n        # Получаем URI из окружения\n        mongo_uri = os.getenv(\"MONGO_URI\", \"mongodb://localhost:27017\")\n    \n        # 1. Загрузка данных\n        with allure.step(\"Загрузка данных из MongoDB\"):\n            ds_tech, ds_know, logs, _ = await prepare_ragas_datasets(mongo_uri)\n    \n            if not logs or log_index >= len(logs):\n                pytest.skip(f\"Лог под индексом {log_index} отсутствует в базе (pending)\")\n    \n            current_log = logs[log_index]\n            log_id = str(current_log[\"_id\"])\n            allure.dynamic.title(f\"Аудит лога: {log_id}\")\n            allure.dynamic.description(f\"Запрос пользователя: {current_log.get('user_query')}\")\n    \n        # 2. Техническая проверка (Планеты)\n        with allure.step(\"\uD83E\uDE90 Технический аудит: Точность планет\"):\n            res_t = evaluate(ds_tech.select([log_index]), metrics=[faithfulness],\n                             llm=judge_llm, embeddings=judge_embeddings).to_pandas()\n            tech_score = float(res_t[\"faithfulness\"].iloc[0])\n    \n            allure.attach(f\"Score: {tech_score}\", name=\"Technical Faithfulness\",\n                          attachment_type=allure.attachment_type.TEXT)\n            # Если тех. точность критически важна, можно добавить:\n            # assert tech_score >= 0.5, \"Бот исказил положение планет!\"\n    \n        # 3. Контентная проверка (RAG)\n        with allure.step(\"\uD83D\uDCDA Контентный аудит: Работа с PDF базой\"):\n            metrics = [faithfulness, answer_relevancy, context_precision]\n            res_k = evaluate(ds_know.select([log_index]), metrics=metrics,\n                             llm=judge_llm, embeddings=judge_embeddings).to_pandas()\n    \n            f_score = float(res_k[\"faithfulness\"].iloc[0])\n            r_score = float(res_k[\"answer_relevancy\"].iloc[0])\n            p_score = float(res_k[\"context_precision\"].iloc[0])\n    \n            # Передаем метрики в Allure как параметры для графиков\n            allure.dynamic.parameter(\"Knowledge Faithfulness\", f_score)\n            allure.dynamic.parameter(\"Context Precision\", p_score)\n            allure.dynamic.parameter(\"Answer Relevancy\", r_score)\n    \n            allure.attach(res_k.to_json(orient=\"records\"), name=\"Detailed Metrics JSON\",\n                          attachment_type=allure.attachment_type.JSON)\n    \n        # 4. Анализ текстов (Сравнение)\n        with allure.step(\"\uD83D\uDD0D Сравнение: Что в базе vs Что в ответе\"):\n            comparison_text = (\n                f\"ЗАПРОС: {current_log.get('user_query')}\\n\\n\"\n                f\"ОТВЕТ ИИ: {ds_know.select([log_index])['answer'][0]}\\n\\n\"\n                f\"НАЙДЕННЫЙ КОНТЕКСТ: {ds_know.select([log_index])['contexts'][0]}\\n\\n\"\n                f\"ЭТАЛОН: {ds_know.select([log_index])['reference'][0]}\"\n            )\n            allure.attach(comparison_text, name=\"Context & Answer Comparison\",\n                          attachment_type=allure.attachment_type.TEXT)\n    \n        # 5. Итоговый Quality Gate\n        with allure.step(\"\uD83C\uDFC1 Финальный вердикт\"):\n            if f_score < 0.3:\n>               allure.dynamic.status_details(f\"Низкое качество: {f_score}\")\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nE               AttributeError: type object 'Dynamic' has no attribute 'status_details'\n\ntests/test_rag_quality.py:87: AttributeError","flaky":false,"newFailed":false,"newBroken":false,"newPassed":false,"retriesCount":0,"retriesStatusChange":false,"beforeStages":[{"name":"event_loop_policy","time":{"start":1769111305440,"stop":1769111305440,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"_function_scoped_runner","time":{"start":1769111363784,"stop":1769111363785,"duration":1},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false}],"testStage":{"description":"Запрос пользователя: name='Собака' date='1980-03-14' time='17:30' city='Иркутск' latitude=52.286 longitude=104.2807 timezone='Asia/Irkutsk' utc_offset=8.0 julian_day=2444312.89583 lagna=134.77 sign='Лев' planets={'Лагна': PlanetDetail(degree=\"14°46'28''\", sign='Лев', house=1, nakshatra='Пурва-Пхалгуни', pada=1, nakshatra_lord='Венера', retrograde=False, display_name='Лагна', longitude=None), 'Солнце': PlanetDetail(degree=\"0°22'44''\", sign='Рыбы', house=8, nakshatra='Пурва-Бхадрапада', pada=4, nakshatra_lord='Юпитер', retrograde=False, display_name='Солнце', longitude=None), 'Луна': PlanetDetail(degree=\"26°43'38''\", sign='Козерог', house=6, nakshatra='Дхаништха', pada=2, nakshatra_lord='Марс', retrograde=False, display_name='Луна', longitude=26.72722222222222), 'Марс': PlanetDetail(degree=\"5°39'9''\", sign='Лев', house=1, nakshatra='Магха', pada=2, nakshatra_lord='Кету', retrograde=True, display_name='Марс R', longitude=None), 'Меркурий': PlanetDetail(degree=\"15°13'5''\", sign='Водолей', house=7, nakshatra='Шатабхиша', pada=3, nakshatra_lord='Раху', retrograde=True, display_name='Меркурий R', longitude=None), 'Юпитер': PlanetDetail(degree=\"9°21'28''\", sign='Лев', house=1, nakshatra='Магха', pada=3, nakshatra_lord='Кету', retrograde=True, display_name='Юпитер R', longitude=None), 'Венера': PlanetDetail(degree=\"14°54'20''\", sign='Овен', house=9, nakshatra='Бхарани', pada=1, nakshatra_lord='Венера', retrograde=False, display_name='Венера', longitude=None), 'Сатурн': PlanetDetail(degree=\"0°2'39''\", sign='Дева', house=2, nakshatra='Уттара-Пхалгуни', pada=2, nakshatra_lord='Солнце', retrograde=True, display_name='Сатурн R', longitude=None), 'Раху': PlanetDetail(degree=\"4°25'44''\", sign='Лев', house=1, nakshatra='Магха', pada=2, nakshatra_lord='Кету', retrograde=True, display_name='Раху R', longitude=None), 'Кету': PlanetDetail(degree=\"4°25'44''\", sign='Водолей', house=7, nakshatra='Дхаништха', pada=4, nakshatra_lord='Марс', retrograde=True, display_name='Кету R', longitude=None)}","status":"broken","statusMessage":"AttributeError: type object 'Dynamic' has no attribute 'status_details'","statusTrace":"self = <tests.test_rag_quality.TestJoytishRagas object at 0x7f05d1f0d6d0>\nlog_index = 1\n\n    @allure.story(\"Аудит точности ответов и поиска\")\n    @pytest.mark.asyncio\n    @pytest.mark.parametrize(\"log_index\", range(5))\n    async def test_ragas_full_audit(self, log_index):\n        \"\"\"\n        Профессиональный аудит логов:\n        1. Проверка соответствия планетам (Technical)\n        2. Проверка соответствия базе знаний PDF (Knowledge)\n        \"\"\"\n        # Получаем URI из окружения\n        mongo_uri = os.getenv(\"MONGO_URI\", \"mongodb://localhost:27017\")\n    \n        # 1. Загрузка данных\n        with allure.step(\"Загрузка данных из MongoDB\"):\n            ds_tech, ds_know, logs, _ = await prepare_ragas_datasets(mongo_uri)\n    \n            if not logs or log_index >= len(logs):\n                pytest.skip(f\"Лог под индексом {log_index} отсутствует в базе (pending)\")\n    \n            current_log = logs[log_index]\n            log_id = str(current_log[\"_id\"])\n            allure.dynamic.title(f\"Аудит лога: {log_id}\")\n            allure.dynamic.description(f\"Запрос пользователя: {current_log.get('user_query')}\")\n    \n        # 2. Техническая проверка (Планеты)\n        with allure.step(\"\uD83E\uDE90 Технический аудит: Точность планет\"):\n            res_t = evaluate(ds_tech.select([log_index]), metrics=[faithfulness],\n                             llm=judge_llm, embeddings=judge_embeddings).to_pandas()\n            tech_score = float(res_t[\"faithfulness\"].iloc[0])\n    \n            allure.attach(f\"Score: {tech_score}\", name=\"Technical Faithfulness\",\n                          attachment_type=allure.attachment_type.TEXT)\n            # Если тех. точность критически важна, можно добавить:\n            # assert tech_score >= 0.5, \"Бот исказил положение планет!\"\n    \n        # 3. Контентная проверка (RAG)\n        with allure.step(\"\uD83D\uDCDA Контентный аудит: Работа с PDF базой\"):\n            metrics = [faithfulness, answer_relevancy, context_precision]\n            res_k = evaluate(ds_know.select([log_index]), metrics=metrics,\n                             llm=judge_llm, embeddings=judge_embeddings).to_pandas()\n    \n            f_score = float(res_k[\"faithfulness\"].iloc[0])\n            r_score = float(res_k[\"answer_relevancy\"].iloc[0])\n            p_score = float(res_k[\"context_precision\"].iloc[0])\n    \n            # Передаем метрики в Allure как параметры для графиков\n            allure.dynamic.parameter(\"Knowledge Faithfulness\", f_score)\n            allure.dynamic.parameter(\"Context Precision\", p_score)\n            allure.dynamic.parameter(\"Answer Relevancy\", r_score)\n    \n            allure.attach(res_k.to_json(orient=\"records\"), name=\"Detailed Metrics JSON\",\n                          attachment_type=allure.attachment_type.JSON)\n    \n        # 4. Анализ текстов (Сравнение)\n        with allure.step(\"\uD83D\uDD0D Сравнение: Что в базе vs Что в ответе\"):\n            comparison_text = (\n                f\"ЗАПРОС: {current_log.get('user_query')}\\n\\n\"\n                f\"ОТВЕТ ИИ: {ds_know.select([log_index])['answer'][0]}\\n\\n\"\n                f\"НАЙДЕННЫЙ КОНТЕКСТ: {ds_know.select([log_index])['contexts'][0]}\\n\\n\"\n                f\"ЭТАЛОН: {ds_know.select([log_index])['reference'][0]}\"\n            )\n            allure.attach(comparison_text, name=\"Context & Answer Comparison\",\n                          attachment_type=allure.attachment_type.TEXT)\n    \n        # 5. Итоговый Quality Gate\n        with allure.step(\"\uD83C\uDFC1 Финальный вердикт\"):\n            if f_score < 0.3:\n>               allure.dynamic.status_details(f\"Низкое качество: {f_score}\")\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nE               AttributeError: type object 'Dynamic' has no attribute 'status_details'\n\ntests/test_rag_quality.py:87: AttributeError","steps":[{"name":"Загрузка данных из MongoDB","time":{"start":1769111363785,"stop":1769111363829,"duration":44},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"\uD83E\uDE90 Технический аудит: Точность планет","time":{"start":1769111363829,"stop":1769111374814,"duration":10985},"status":"passed","steps":[],"attachments":[{"uid":"ce2ccdf0852a4c57","name":"Technical Faithfulness","source":"ce2ccdf0852a4c57.txt","type":"text/plain","size":10}],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":1,"hasContent":true,"attachmentStep":false},{"name":"\uD83D\uDCDA Контентный аудит: Работа с PDF базой","time":{"start":1769111374814,"stop":1769111394721,"duration":19907},"status":"passed","steps":[],"attachments":[{"uid":"1ff6fcb05acec9e","name":"Detailed Metrics JSON","source":"1ff6fcb05acec9e.json","type":"application/json","size":40479}],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":1,"hasContent":true,"attachmentStep":false},{"name":"\uD83D\uDD0D Сравнение: Что в базе vs Что в ответе","time":{"start":1769111394721,"stop":1769111394725,"duration":4},"status":"passed","steps":[],"attachments":[{"uid":"cbd8e2b9628825f2","name":"Context & Answer Comparison","source":"cbd8e2b9628825f2.txt","type":"text/plain","size":15604}],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":1,"hasContent":true,"attachmentStep":false},{"name":"\uD83C\uDFC1 Финальный вердикт","time":{"start":1769111394725,"stop":1769111394725,"duration":0},"status":"broken","statusMessage":"AttributeError: type object 'Dynamic' has no attribute 'status_details'\n","statusTrace":"  File \"/home/runner/work/joytishai/joytishai/tests/test_rag_quality.py\", line 87, in test_ragas_full_audit\n    allure.dynamic.status_details(f\"Низкое качество: {f_score}\")\n    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":true,"attachmentsCount":0,"hasContent":true,"attachmentStep":false}],"attachments":[{"uid":"ddc5d854a3394972","name":"log","source":"ddc5d854a3394972.txt","type":"text/plain","size":1789}],"parameters":[],"stepsCount":5,"shouldDisplayMessage":true,"attachmentsCount":4,"hasContent":true,"attachmentStep":false},"afterStages":[{"name":"_function_scoped_runner::0","time":{"start":1769111394731,"stop":1769111394731,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false}],"labels":[{"name":"epic","value":"Астрологический ИИ"},{"name":"feature","value":"Качество RAG системы"},{"name":"story","value":"Аудит точности ответов и поиска"},{"name":"tag","value":"asyncio"},{"name":"parentSuite","value":"tests"},{"name":"suite","value":"test_rag_quality"},{"name":"subSuite","value":"TestJoytishRagas"},{"name":"host","value":"runnervmmtnos"},{"name":"thread","value":"2924-MainThread"},{"name":"framework","value":"pytest"},{"name":"language","value":"cpython3"},{"name":"package","value":"tests.test_rag_quality"},{"name":"resultFormat","value":"allure2"}],"parameters":[{"name":"Answer Relevancy","value":"0.32361774570185675"},{"name":"Context Precision","value":"0.0"},{"name":"Knowledge Faithfulness","value":"0.0"},{"name":"log_index","value":"1"}],"links":[],"hidden":false,"retry":false,"extra":{"severity":"normal","retries":[],"categories":[{"name":"Test defects","matchedStatuses":[],"flaky":false}],"tags":["asyncio"]},"source":"360900af2ac46295.json","parameterValues":["0.32361774570185675","0.0","0.0","1"]}