{"uid":"a6b5bf1a824a1b43","name":"test_api_consultation_full_flow","fullName":"tests.test_ai_consultation#test_api_consultation_full_flow","historyId":"892bc8f618f8d963900ce604d8942066","time":{"start":1769167829034,"stop":1769167844336,"duration":15302},"status":"failed","statusMessage":"AssertionError: assert 'recommendations' in \"AI Generation Error: Error code: 429 - {'error': {'message': 'You exceeded your current quota, please check your plan and billing details. For more information on this error, read the docs: https://platform.openai.com/docs/guides/error-codes/api-errors.', 'type': 'insufficient_quota', 'param': None, 'code': 'insufficient_quota'}}\"","statusTrace":"@pytest.mark.asyncio\n    async def test_api_consultation_full_flow():\n        # Собираем URL из компонентов\n        base_url = os.getenv(\"TEST_API_URL\", \"http://127.0.0.1:8000\")\n        endpoint = os.getenv(\"ANALYZE_ENDPOINT\", \"/api/v1/forecast/generate\")\n    \n        # Убираем возможные двойные слэши, если они случайно попали в .env\n        api_url = f\"{base_url.rstrip('/')}{endpoint}\"\n    \n        print(f\"\\n\uD83D\uDE80 Target API: {api_url}\")\n        \"\"\"\n        End-to-End TEST CHECKING ALL SYSTEM AND FINAL WORKING PROCESS\n        \"\"\"\n    \n        payload = {\n            \"chart_data\": {\n                \"name\": \"Собака\",\n                \"date\": \"1980-03-14\",\n                \"time\": \"17:30\",\n                \"city\": \"Иркутск\",\n                \"latitude\": 52.286,\n                \"longitude\": 104.2807,\n                \"timezone\": \"Asia/Irkutsk\",\n                \"utc_offset\": 8.0,\n                \"julian_day\": 2444312.89583,\n                \"lagna\": 134.77,\n                \"sign\": \"Лев\",\n                \"planets\": {\n                    \"Лагна\": {\n                        \"degree\": \"14°46'28''\",\n                        \"sign\": \"Лев\",\n                        \"house\": 1,\n                        \"nakshatra\": \"Пурва-Пхалгуни\",\n                        \"pada\": 1,\n                        \"nakshatra_lord\": \"Венера\",\n                        \"retrograde\": False,\n                        \"display_name\": \"Лагна\",\n                    },\n                    \"Солнце\": {\n                        \"degree\": \"0°22'44''\",\n                        \"sign\": \"Рыбы\",\n                        \"house\": 8,\n                        \"nakshatra\": \"Пурва-Бхадрапада\",\n                        \"pada\": 4,\n                        \"nakshatra_lord\": \"Юпитер\",\n                        \"retrograde\": False,\n                        \"display_name\": \"Солнце\",\n                    },\n                    \"Луна\": {\n                        \"degree\": \"26°43'38''\",\n                        \"sign\": \"Козерог\",\n                        \"house\": 6,\n                        \"nakshatra\": \"Дхаништха\",\n                        \"pada\": 2,\n                        \"nakshatra_lord\": \"Марс\",\n                        \"retrograde\": False,\n                        \"display_name\": \"Луна\",\n                        \"longitude\": 26.72722222222222,\n                    },\n                    \"Марс\": {\n                        \"degree\": \"5°39'9''\",\n                        \"sign\": \"Лев\",\n                        \"house\": 1,\n                        \"nakshatra\": \"Магха\",\n                        \"pada\": 2,\n                        \"nakshatra_lord\": \"Кету\",\n                        \"retrograde\": True,\n                        \"display_name\": \"Марс R\",\n                    },\n                    \"Меркурий\": {\n                        \"degree\": \"15°13'5''\",\n                        \"sign\": \"Водолей\",\n                        \"house\": 7,\n                        \"nakshatra\": \"Шатабхиша\",\n                        \"pada\": 3,\n                        \"nakshatra_lord\": \"Раху\",\n                        \"retrograde\": True,\n                        \"display_name\": \"Меркурий R\",\n                    },\n                    \"Юпитер\": {\n                        \"degree\": \"9°21'28''\",\n                        \"sign\": \"Лев\",\n                        \"house\": 1,\n                        \"nakshatra\": \"Магха\",\n                        \"pada\": 3,\n                        \"nakshatra_lord\": \"Кету\",\n                        \"retrograde\": True,\n                        \"display_name\": \"Юпитер R\",\n                    },\n                    \"Венера\": {\n                        \"degree\": \"14°54'20''\",\n                        \"sign\": \"Овен\",\n                        \"house\": 9,\n                        \"nakshatra\": \"Бхарани\",\n                        \"pada\": 1,\n                        \"nakshatra_lord\": \"Венера\",\n                        \"retrograde\": False,\n                        \"display_name\": \"Венера\",\n                    },\n                    \"Сатурн\": {\n                        \"degree\": \"0°2'39''\",\n                        \"sign\": \"Дева\",\n                        \"house\": 2,\n                        \"nakshatra\": \"Уттара-Пхалгуни\",\n                        \"pada\": 2,\n                        \"nakshatra_lord\": \"Солнце\",\n                        \"retrograde\": True,\n                        \"display_name\": \"Сатурн R\",\n                    },\n                    \"Раху\": {\n                        \"degree\": \"4°25'44''\",\n                        \"sign\": \"Лев\",\n                        \"house\": 1,\n                        \"nakshatra\": \"Магха\",\n                        \"pada\": 2,\n                        \"nakshatra_lord\": \"Кету\",\n                        \"retrograde\": True,\n                        \"display_name\": \"Раху R\",\n                    },\n                    \"Кету\": {\n                        \"degree\": \"4°25'44''\",\n                        \"sign\": \"Водолей\",\n                        \"house\": 7,\n                        \"nakshatra\": \"Дхаништха\",\n                        \"pada\": 4,\n                        \"nakshatra_lord\": \"Марс\",\n                        \"retrograde\": True,\n                        \"display_name\": \"Кету R\",\n                    },\n                },\n            },\n            \"transit_date\": \"2026-01-02\",\n        }\n    \n        async with httpx.AsyncClient() as client:\n            response = await client.post(api_url, json=payload, timeout=60.0)\n    \n        assert response.status_code == 200\n    \n        data = response.json()\n    \n        # Извлекаем анализ\n        # ... (предыдущая часть кода теста)\n    \n        # Извлекаем анализ\n        ai_report = data.get(\"ai_analysis\")\n    \n        print(\"\\n\" + \"=\" * 60)\n        print(\"\uD83E\uDD16 AI RESPONSE RECEIVED:\")\n        print(\"=\" * 60)\n    \n        # Если ИИ прислал словарь (JSON)\n        if isinstance(ai_report, dict):\n            print(f\"\uD83D\uDCCC TITLE: {ai_report.get('daily_title')}\")\n            print(f\"\uD83D\uDD2C ANALYSIS: {ai_report.get('astrological_analysis')}\")\n            print(f\"\uD83C\uDFDB WISDOM: {ai_report.get('classic_wisdom')}\")\n    \n            # --- НОВЫЙ БЛОК: РЕКОМЕНДАЦИИ ---\n            print(\"\\n\uD83D\uDCA1 RECOMMENDATIONS:\")\n            recs = ai_report.get(\"recommendations\", [])\n            if recs:\n                for idx, rec in enumerate(recs, 1):\n                    print(f\"  {idx}. {rec}\")\n            else:\n                print(\"  (No recommendations provided)\")\n            # -------------------------------\n    \n        else:\n            print(ai_report)\n    \n        # Добавим также проверку (assertion), что рекомендации пришли и это список\n>       assert \"recommendations\" in ai_report\nE       assert 'recommendations' in \"AI Generation Error: Error code: 429 - {'error': {'message': 'You exceeded your current quota, please check your plan and billing details. For more information on this error, read the docs: https://platform.openai.com/docs/guides/error-codes/api-errors.', 'type': 'insufficient_quota', 'param': None, 'code': 'insufficient_quota'}}\"\n\ntests/test_ai_consultation.py:184: AssertionError","flaky":false,"newFailed":false,"newBroken":false,"newPassed":false,"retriesCount":0,"retriesStatusChange":false,"beforeStages":[{"name":"_function_scoped_runner","time":{"start":1769167829034,"stop":1769167829034,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"event_loop_policy","time":{"start":1769167829034,"stop":1769167829034,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false}],"testStage":{"status":"failed","statusMessage":"AssertionError: assert 'recommendations' in \"AI Generation Error: Error code: 429 - {'error': {'message': 'You exceeded your current quota, please check your plan and billing details. For more information on this error, read the docs: https://platform.openai.com/docs/guides/error-codes/api-errors.', 'type': 'insufficient_quota', 'param': None, 'code': 'insufficient_quota'}}\"","statusTrace":"@pytest.mark.asyncio\n    async def test_api_consultation_full_flow():\n        # Собираем URL из компонентов\n        base_url = os.getenv(\"TEST_API_URL\", \"http://127.0.0.1:8000\")\n        endpoint = os.getenv(\"ANALYZE_ENDPOINT\", \"/api/v1/forecast/generate\")\n    \n        # Убираем возможные двойные слэши, если они случайно попали в .env\n        api_url = f\"{base_url.rstrip('/')}{endpoint}\"\n    \n        print(f\"\\n\uD83D\uDE80 Target API: {api_url}\")\n        \"\"\"\n        End-to-End TEST CHECKING ALL SYSTEM AND FINAL WORKING PROCESS\n        \"\"\"\n    \n        payload = {\n            \"chart_data\": {\n                \"name\": \"Собака\",\n                \"date\": \"1980-03-14\",\n                \"time\": \"17:30\",\n                \"city\": \"Иркутск\",\n                \"latitude\": 52.286,\n                \"longitude\": 104.2807,\n                \"timezone\": \"Asia/Irkutsk\",\n                \"utc_offset\": 8.0,\n                \"julian_day\": 2444312.89583,\n                \"lagna\": 134.77,\n                \"sign\": \"Лев\",\n                \"planets\": {\n                    \"Лагна\": {\n                        \"degree\": \"14°46'28''\",\n                        \"sign\": \"Лев\",\n                        \"house\": 1,\n                        \"nakshatra\": \"Пурва-Пхалгуни\",\n                        \"pada\": 1,\n                        \"nakshatra_lord\": \"Венера\",\n                        \"retrograde\": False,\n                        \"display_name\": \"Лагна\",\n                    },\n                    \"Солнце\": {\n                        \"degree\": \"0°22'44''\",\n                        \"sign\": \"Рыбы\",\n                        \"house\": 8,\n                        \"nakshatra\": \"Пурва-Бхадрапада\",\n                        \"pada\": 4,\n                        \"nakshatra_lord\": \"Юпитер\",\n                        \"retrograde\": False,\n                        \"display_name\": \"Солнце\",\n                    },\n                    \"Луна\": {\n                        \"degree\": \"26°43'38''\",\n                        \"sign\": \"Козерог\",\n                        \"house\": 6,\n                        \"nakshatra\": \"Дхаништха\",\n                        \"pada\": 2,\n                        \"nakshatra_lord\": \"Марс\",\n                        \"retrograde\": False,\n                        \"display_name\": \"Луна\",\n                        \"longitude\": 26.72722222222222,\n                    },\n                    \"Марс\": {\n                        \"degree\": \"5°39'9''\",\n                        \"sign\": \"Лев\",\n                        \"house\": 1,\n                        \"nakshatra\": \"Магха\",\n                        \"pada\": 2,\n                        \"nakshatra_lord\": \"Кету\",\n                        \"retrograde\": True,\n                        \"display_name\": \"Марс R\",\n                    },\n                    \"Меркурий\": {\n                        \"degree\": \"15°13'5''\",\n                        \"sign\": \"Водолей\",\n                        \"house\": 7,\n                        \"nakshatra\": \"Шатабхиша\",\n                        \"pada\": 3,\n                        \"nakshatra_lord\": \"Раху\",\n                        \"retrograde\": True,\n                        \"display_name\": \"Меркурий R\",\n                    },\n                    \"Юпитер\": {\n                        \"degree\": \"9°21'28''\",\n                        \"sign\": \"Лев\",\n                        \"house\": 1,\n                        \"nakshatra\": \"Магха\",\n                        \"pada\": 3,\n                        \"nakshatra_lord\": \"Кету\",\n                        \"retrograde\": True,\n                        \"display_name\": \"Юпитер R\",\n                    },\n                    \"Венера\": {\n                        \"degree\": \"14°54'20''\",\n                        \"sign\": \"Овен\",\n                        \"house\": 9,\n                        \"nakshatra\": \"Бхарани\",\n                        \"pada\": 1,\n                        \"nakshatra_lord\": \"Венера\",\n                        \"retrograde\": False,\n                        \"display_name\": \"Венера\",\n                    },\n                    \"Сатурн\": {\n                        \"degree\": \"0°2'39''\",\n                        \"sign\": \"Дева\",\n                        \"house\": 2,\n                        \"nakshatra\": \"Уттара-Пхалгуни\",\n                        \"pada\": 2,\n                        \"nakshatra_lord\": \"Солнце\",\n                        \"retrograde\": True,\n                        \"display_name\": \"Сатурн R\",\n                    },\n                    \"Раху\": {\n                        \"degree\": \"4°25'44''\",\n                        \"sign\": \"Лев\",\n                        \"house\": 1,\n                        \"nakshatra\": \"Магха\",\n                        \"pada\": 2,\n                        \"nakshatra_lord\": \"Кету\",\n                        \"retrograde\": True,\n                        \"display_name\": \"Раху R\",\n                    },\n                    \"Кету\": {\n                        \"degree\": \"4°25'44''\",\n                        \"sign\": \"Водолей\",\n                        \"house\": 7,\n                        \"nakshatra\": \"Дхаништха\",\n                        \"pada\": 4,\n                        \"nakshatra_lord\": \"Марс\",\n                        \"retrograde\": True,\n                        \"display_name\": \"Кету R\",\n                    },\n                },\n            },\n            \"transit_date\": \"2026-01-02\",\n        }\n    \n        async with httpx.AsyncClient() as client:\n            response = await client.post(api_url, json=payload, timeout=60.0)\n    \n        assert response.status_code == 200\n    \n        data = response.json()\n    \n        # Извлекаем анализ\n        # ... (предыдущая часть кода теста)\n    \n        # Извлекаем анализ\n        ai_report = data.get(\"ai_analysis\")\n    \n        print(\"\\n\" + \"=\" * 60)\n        print(\"\uD83E\uDD16 AI RESPONSE RECEIVED:\")\n        print(\"=\" * 60)\n    \n        # Если ИИ прислал словарь (JSON)\n        if isinstance(ai_report, dict):\n            print(f\"\uD83D\uDCCC TITLE: {ai_report.get('daily_title')}\")\n            print(f\"\uD83D\uDD2C ANALYSIS: {ai_report.get('astrological_analysis')}\")\n            print(f\"\uD83C\uDFDB WISDOM: {ai_report.get('classic_wisdom')}\")\n    \n            # --- НОВЫЙ БЛОК: РЕКОМЕНДАЦИИ ---\n            print(\"\\n\uD83D\uDCA1 RECOMMENDATIONS:\")\n            recs = ai_report.get(\"recommendations\", [])\n            if recs:\n                for idx, rec in enumerate(recs, 1):\n                    print(f\"  {idx}. {rec}\")\n            else:\n                print(\"  (No recommendations provided)\")\n            # -------------------------------\n    \n        else:\n            print(ai_report)\n    \n        # Добавим также проверку (assertion), что рекомендации пришли и это список\n>       assert \"recommendations\" in ai_report\nE       assert 'recommendations' in \"AI Generation Error: Error code: 429 - {'error': {'message': 'You exceeded your current quota, please check your plan and billing details. For more information on this error, read the docs: https://platform.openai.com/docs/guides/error-codes/api-errors.', 'type': 'insufficient_quota', 'param': None, 'code': 'insufficient_quota'}}\"\n\ntests/test_ai_consultation.py:184: AssertionError","steps":[],"attachments":[{"uid":"eee847393825986","name":"log","source":"eee847393825986.txt","type":"text/plain","size":114}],"parameters":[],"stepsCount":0,"shouldDisplayMessage":true,"attachmentsCount":1,"hasContent":true,"attachmentStep":false},"afterStages":[{"name":"_function_scoped_runner::0","time":{"start":1769167844494,"stop":1769167844495,"duration":1},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":false,"attachmentsCount":0,"hasContent":false,"attachmentStep":false}],"labels":[{"name":"tag","value":"asyncio"},{"name":"parentSuite","value":"tests"},{"name":"suite","value":"test_ai_consultation"},{"name":"host","value":"runnervmymu0l"},{"name":"thread","value":"2976-MainThread"},{"name":"framework","value":"pytest"},{"name":"language","value":"cpython3"},{"name":"package","value":"tests.test_ai_consultation"},{"name":"resultFormat","value":"allure2"}],"parameters":[],"links":[],"hidden":false,"retry":false,"extra":{"severity":"normal","retries":[],"categories":[{"name":"Product defects","matchedStatuses":[],"flaky":false}],"tags":["asyncio"]},"source":"a6b5bf1a824a1b43.json","parameterValues":[]}